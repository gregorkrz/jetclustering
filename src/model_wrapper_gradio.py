# A simple wrapper to run the L-GATr model on HuggingFace spaces
import shutil
import glob
import argparse
import functools
import numpy as np
import math
import torch
import sys
import os
import wandb
import time
from pathlib import Path
from src.layers.object_cond import calc_eta_phi
torch.autograd.set_detect_anomaly(True)
from src.dataset.functions_data import get_batch
from src.dataset.functions_data import concat_events, Event, EventPFCands
from src.plotting.plot_event import plot_event
from src.dataset.dataset import EventDataset
from src.jetfinder.clustering import get_clustering_labels
from torch_scatter import scatter_sum

from src.utils.train_utils import (
    to_filelist,
    train_load,
    test_load,
    get_model,
    get_optimizer_and_scheduler,
    get_model_obj_score
)
from src.utils.paths import get_path
import warnings
import pickle
import os

import fastjet

args = argparse.ArgumentParser()
args.spatial_part_only = True # LGATr
args.load_model_weights =  get_path("train/Delphes_Aug_IRCSplit_50k_SN_from3kFT_2025_05_16_14_07_29_474/step_21060_epoch_2.ckpt", "results", fallback=True) # for debugging
args.aug_soft = True # LGATr_GP etc.
args.network_config = "src/models/LGATr/lgatr.py"
args.beta_type = "pt+bc"
args.embed_as_vectors = False
args.debug = False
args.epsilon = 0.3
args.gen_level = False
args.parton_level = False
args.global_features_obj_score = False
args.gt_radius = 0.8
args.no_pid = True
args.hidden_mv_channels = 16
args.hidden_s_channels = 64
args.internal_dim = 128
args.lorentz_norm = False
args.min_cluster_size = 2
args.min_samples = 1
args.n_heads = 4
args.num_blocks = 10
args.scalars_oc=False

dev = torch.device("cpu")
model = get_model(args, dev)
orig_model = model
batch_config = {"use_p_xyz": True, "use_four_momenta": False}

if "lgatr" in args.network_config.lower():
    batch_config = {"use_four_momenta": True}
batch_config["no_pid"] = True

print("batch_config:", batch_config)
model.eval()


# INPUTS
pt = [1, 2, 3]
eta = [0.5, 0.6, 0.7]
phi = [0, 2, -1]
charge = [0, -1, 1]
mass = [0.511, 0, 0]

input_text = """1.285908579826355 -2.2064461708068848 2.6301612854003906 0.9382699728012085 1.0
0.7487459778785706 -2.094208240509033 -0.05120047181844711 0.4936800003051758 -1.0
0.5246888995170593 -2.007927417755127 2.989550828933716 0.4936800003051758 -1.0
2.7525248527526855 -1.9870414733886719 -0.4528072476387024 0.13956999778747559 1.0
0.7956375479698181 -2.04066801071167 2.194350004196167 0.13956999778747559 -1.0
0.9809597134590149 -1.8432270288467407 -2.1718909740448 0.13956999778747559 1.0
0.6347672343254089 -1.8870458602905273 -2.357295513153076 0.13956999778747559 -1.0
0.5286186337471008 -1.8677940368652344 -1.5477248430252075 0.13956999778747559 -1.0
11.700090408325195 -1.7546323537826538 -0.2974643111228943 0.13956999778747559 1.0
4.672840118408203 -1.7406619787216187 -0.5989688038825989 0.13956999778747559 -1.0
0.9087695479393005 -1.68337881565094 -2.4570295810699463 0.13956999778747559 -1.0
3.460341215133667 -1.703657627105713 -0.5562939047813416 0.13956999778747559 1.0
1.8114593029022217 -1.3267972469329834 -0.5191969275474548 0.4936800003051758 -1.0
1.7149032354354858 -1.1945360898971558 0.32848119735717773 0.4936800003051758 -1.0
1.2845592498779297 -1.03621506690979 1.9651798009872437 0.4936800003051758 1.0
0.8349813222885132 -0.5699279308319092 -0.029887989163398743 0.13956999778747559 1.0
1.1308070421218872 -0.4994378685951233 2.56583833694458 0.13956999778747559 1.0
0.8581411838531494 -0.4269869029521942 0.5446347594261169 0.13956999778747559 -1.0
1.0720726251602173 -0.3555384576320648 -3.059396505355835 0.13956999778747559 1.0
1.3427362442016602 -0.1894076019525528 -2.8412978649139404 0.13956999778747559 -1.0
1.3493661880493164 0.4127936065196991 1.7053676843643188 0.13956999778747559 1.0
1.55831778049469 0.4903299808502197 -1.5499778985977173 0.13956999778747559 1.0
6.850871562957764 0.4772738814353943 -1.4543260335922241 0.13956999778747559 1.0
8.582344055175781 0.5117385387420654 -1.4390026330947876 0.4936800003051758 1.0
7.369996070861816 0.4535500705242157 -1.4423576593399048 0.4936800003051758 -1.0
1.6464149951934814 0.5791456699371338 -1.9467434883117676 0.4936800003051758 1.0
21.498641967773438 0.5266798138618469 -1.4554439783096313 0.4936800003051758 -1.0
8.963800430297852 0.5426040291786194 -1.3467090129852295 0.13956999778747559 -1.0
1.332951545715332 0.6667371988296509 -1.456124186515808 0.13956999778747559 -1.0
1.4493573904037476 0.7821112275123596 1.338742971420288 0.13956999778747559 -1.0
2.704180955886841 0.9362266063690186 1.8429251909255981 0.13956999778747559 1.0
18.941211700439453 0.9151712656021118 2.007201910018921 0.4936800003051758 1.0
16.181575775146484 0.8733822107315063 2.063425064086914 0.0005110002239234746 -1.0
4.140904426574707 0.9097205996513367 2.311692476272583 0.13956999778747559 1.0
1.65585196018219 0.9911935329437256 -2.927703619003296 0.13956999778747559 -1.0
0.8846070766448975 1.0426397323608398 1.066613793373108 0.13956999778747559 1.0
1.054222583770752 0.9839426279067993 1.3207497596740723 0.9382699728012085 1.0
2.8340156078338623 1.0142217874526978 1.9148632287979126 0.13956999778747559 -1.0
3.116788387298584 1.0746370553970337 1.7928866147994995 0.13956999778747559 -1.0
1.8012828826904297 1.1586496829986572 1.6795539855957031 0.13956999778747559 1.0
3.0504701137542725 1.1395117044448853 1.8572102785110474 0.13956999778747559 -1.0
2.317504405975342 1.235701084136963 1.8641473054885864 0.13956999778747559 -1.0
1.3057663440704346 1.4062622785568237 -2.100675582885742 0.13956999778747559 1.0
0.8453368544578552 1.419650673866272 -2.91204571723938 0.13956999778747559 -1.0
0.5769703984260559 1.603403091430664 -2.7231976985931396 0.13956999778747559 1.0
0.8172481656074524 1.690572738647461 -2.174063205718994 0.13956999778747559 1.0
0.7432761788368225 1.9709503650665283 -0.6545511484146118 0.13956999778747559 1.0
1.003330111503601 1.957755446434021 0.7579545378684998 0.13956999778747559 -1.0
1.8586223125457764 2.074205160140991 1.968035340309143 0.9382699728012085 -1.0
8.109560012817383 2.1814541816711426 2.3149867057800293 0.13956999778747559 1.0
0.6520617604255676 2.3831369876861572 -1.781076431274414 0.4936800003051758 -1.0
0.550498902797699 2.361708164215088 1.9065485000610352 0.13956999778747559 1.0
1.11271071434021 -2.3813540935516357 0.09735637158155441 0.0 0.0
1.5287894010543823 -2.221574068069458 -2.210566759109497 -8.429369557916289e-08 0.0
0.6183608770370483 -2.221240282058716 0.6431254148483276 -4.214684778958144e-08 0.0
1.211024522781372 -1.9566999673843384 2.333557367324829 5.960464477539063e-08 0.0
0.6445324420928955 -1.9420228004455566 2.208566188812256 2.9802322387695312e-08 0.0
0.7663082480430603 -1.9107446670532227 -1.6390632390975952 0.0 0.0
0.6305390000343323 -1.8952817916870117 -2.6273038387298584 2.9802322387695312e-08 0.0
1.6763824224472046 -1.8914414644241333 -0.3428950607776642 0.0 0.0
0.9485975503921509 -1.8628748655319214 1.868783950805664 4.214684778958144e-08 0.0
1.5745559930801392 -1.8449265956878662 -0.42849770188331604 -8.429369557916289e-08 0.0
2.108532190322876 -1.8357230424880981 -0.3890358805656433 -8.429369557916289e-08 0.0
3.032390594482422 -1.825714111328125 -0.3301529586315155 2.0647654253025394e-07 0.0
2.1467669010162354 -1.8234453201293945 -0.28642016649246216 8.429369557916289e-08 0.0
1.2778874635696411 -1.7949914932250977 -0.5542489886283875 4.214684778958144e-08 0.0
0.912905216217041 -1.6805322170257568 1.1381043195724487 -5.1619135632563484e-08 0.0
1.2532317638397217 -1.4871019124984741 -1.4817794561386108 0.0 0.0
1.5387523174285889 -1.4224203824996948 1.4819539785385132 0.0 0.0
2.6689887046813965 -1.358622670173645 0.7036111354827881 5.960464477539063e-08 0.0
2.3188722133636475 -1.3341741561889648 -1.752328872680664 8.429369557916289e-08 0.0
0.9236962199211121 -1.3245621919631958 2.707490921020508 0.0 0.0
1.8177824020385742 -1.3222960233688354 -2.190955400466919 -8.429369557916289e-08 0.0
1.052416443824768 -1.1373424530029297 -2.9189302921295166 2.107342389479072e-08 0.0
2.123594045639038 -1.0880649089813232 -1.0246020555496216 -7.300048565639372e-08 0.0
1.964095950126648 -1.0772368907928467 2.488572597503662 4.214684778958144e-08 0.0
3.922567367553711 -1.0374717712402344 0.7515174150466919 -8.429369557916289e-08 0.0
2.100248336791992 -0.8209442496299744 2.760209560394287 4.214684778958144e-08 0.0
0.9352098703384399 -0.7315458059310913 -1.216559648513794 -1.4901161193847656e-08 0.0
2.568833827972412 -0.7045775055885315 1.833177924156189 -4.214684778958144e-08 0.0
1.773956060409546 -0.6078402400016785 2.5342376232147217 -4.214684778958144e-08 0.0
1.5694565773010254 -0.5785274505615234 2.5093085765838623 2.107342389479072e-08 0.0
6.7839274406433105 -0.56248939037323 -2.986403703689575 8.429369557916289e-08 0.0
1.114939570426941 -0.5575534105300903 1.69455087184906 0.0 0.0
5.507236480712891 -0.5244992971420288 1.4929091930389404 0.0 0.0
1.4401556253433228 -0.43264350295066833 -0.8002614974975586 -2.107342389479072e-08 0.0
0.9767805337905884 -0.4173221290111542 2.409954309463501 -1.4901161193847656e-08 0.0
1.0076097249984741 -0.33927080035209656 -0.8337658643722534 0.0 0.0
0.9146650433540344 -0.25581979751586914 2.703824281692505 -1.053671194739536e-08 0.0
2.7623322010040283 -0.23812629282474518 1.6750667095184326 4.214684778958144e-08 0.0
3.0144832134246826 -0.1469791680574417 -2.739244222640991 0.0 0.0
1.2508047819137573 -0.10098464041948318 1.2938188314437866 -2.107342389479072e-08 0.0
1.5031671524047852 -0.08642241358757019 0.2731858789920807 0.0 0.0
1.6019104719161987 0.04195768013596535 2.943544864654541 2.9802322387695312e-08 0.0
1.2830278873443604 0.10771942883729935 -1.7636317014694214 1.4901161193847656e-08 0.0
1.0977004766464233 0.12400612235069275 -2.623702049255371 1.4901161193847656e-08 0.0
2.416353940963745 0.14923568069934845 -2.7312326431274414 2.9802322387695312e-08 0.0
0.9454912543296814 0.16614419221878052 -0.15826834738254547 -1.053671194739536e-08 0.0
1.4195258617401123 0.1856943517923355 -1.3715684413909912 0.0 0.0
1.466599464416504 0.19532646238803864 -2.791978597640991 0.0 0.0
1.2122124433517456 0.33461156487464905 -2.915593385696411 0.0 0.0
1.063982367515564 0.3451996445655823 2.4413726329803467 -1.4901161193847656e-08 0.0
1.974306344985962 0.40378034114837646 -1.3983423709869385 0.0 0.0
1.2610113620758057 0.4231224060058594 1.3117077350616455 -2.5809567816281742e-08 0.0
1.067973017692566 0.4646882116794586 -1.5197961330413818 0.0 0.0
0.9496509432792664 0.454303115606308 -1.5131986141204834 1.4901161193847656e-08 0.0
5.379319190979004 0.507723867893219 -1.5240904092788696 -1.1920928955078125e-07 0.0
1.0865429639816284 0.5226010084152222 -1.3985254764556885 2.107342389479072e-08 0.0
2.5317349433898926 0.5376036763191223 -1.3957425355911255 -4.214684778958144e-08 0.0
2.101804256439209 0.567628800868988 -1.4079632759094238 -2.9802322387695312e-08 0.0
1.073519229888916 0.5969709753990173 2.5630249977111816 -2.5809567816281742e-08 0.0
1.2746238708496094 0.6607993841171265 -2.3673558235168457 -2.9802322387695312e-08 0.0
1.4170644283294678 0.7265937924385071 -1.0004215240478516 0.0 0.0
21.549448013305664 0.7210296988487244 2.681602716445923 3.3717478231665154e-07 0.0
1.186550498008728 0.9094470739364624 -1.1081290245056152 2.9802322387695312e-08 0.0
5.117948055267334 0.9290409684181213 2.0253491401672363 -8.429369557916289e-08 0.0
1.4861501455307007 0.927351713180542 2.08944034576416 2.9802322387695312e-08 0.0
1.6318336725234985 0.9757713675498962 2.031212568283081 0.0 0.0
2.2725889682769775 1.0470476150512695 1.774751901626587 4.214684778958144e-08 0.0
2.2264885902404785 1.0503500699996948 2.0158731937408447 4.214684778958144e-08 0.0
2.373934507369995 1.0720634460449219 1.7128148078918457 5.960464477539063e-08 0.0
1.510032296180725 1.0847829580307007 1.788780689239502 -4.214684778958144e-08 0.0
1.0372703075408936 1.1195467710494995 1.7879420518875122 -2.107342389479072e-08 0.0
1.6704843044281006 1.1290236711502075 2.63218092918396 0.0 0.0
1.5184695720672607 1.1395208835601807 0.6326195597648621 0.0 0.0
2.458073854446411 1.1461107730865479 2.1871731281280518 -5.960464477539063e-08 0.0
0.9845534563064575 1.1658501625061035 -2.487612009048462 4.214684778958144e-08 0.0
1.1499491930007935 1.2241127490997314 2.0117104053497314 0.0 0.0
2.342416524887085 1.2601044178009033 -2.865402936935425 8.429369557916289e-08 0.0
1.6687431335449219 1.264404535293579 -2.7039778232574463 0.0 0.0
0.942179262638092 1.2608128786087036 -2.173363447189331 2.107342389479072e-08 0.0
2.430110216140747 1.3443554639816284 1.084045648574829 0.0 0.0
1.1220529079437256 1.3586798906326294 -2.7192015647888184 2.9802322387695312e-08 0.0
0.9340591430664062 1.407522201538086 -1.102454662322998 -2.9802322387695312e-08 0.0
1.0246495008468628 1.462624192237854 1.6913436651229858 0.0 0.0
1.4762156009674072 1.5041680335998535 -2.0925133228302 -5.960464477539063e-08 0.0
1.1961791515350342 1.6974965333938599 2.9264731407165527 -4.214684778958144e-08 0.0
1.170003056526184 1.7321628332138062 -1.885603904724121 7.300048565639372e-08 0.0
0.8677659034729004 1.776269555091858 -1.0198577642440796 2.9802322387695312e-08 0.0
1.2435728311538696 1.792218565940857 2.3297061920166016 4.214684778958144e-08 0.0
1.5453228950500488 1.886936902999878 1.781978964805603 0.0 0.0
1.3733431100845337 1.930077075958252 -1.5155688524246216 0.0 0.0
1.8659189939498901 1.9565192461013794 -2.7270472049713135 -8.429369557916289e-08 0.0
0.7111741900444031 1.9646193981170654 0.9764125943183899 0.0 0.0
0.9559435248374939 1.990791916847229 -1.3449255228042603 -4.214684778958144e-08 0.0
0.5481534004211426 2.0411131381988525 2.115036964416504 2.9802322387695312e-08 0.0
0.6668163537979126 2.11537766456604 -2.5837104320526123 4.214684778958144e-08 0.0
0.8508790731430054 2.116328001022339 2.6630513668060303 -5.960464477539063e-08 0.0
0.574717104434967 2.1371636390686035 -1.8287789821624756 0.0 0.0
0.8047783970832825 2.178757667541504 -1.245346188545227 -7.300048565639372e-08 0.0
0.8451277017593384 2.2011194229125977 -2.35445237159729 5.960464477539063e-08 0.0
0.5195921659469604 2.2657599449157715 1.3243736028671265 5.1619135632563484e-08 0.0
1.773646593093872 2.3771986961364746 -1.769016981124878 -1.1920928955078125e-07 0.0
0.8486307263374329 2.3816046714782715 2.2308528423309326 5.960464477539063e-08 0.0
0.5535151362419128 2.3867456912994385 2.7641613483428955 0.0 0.0
2.14668345451355 -2.3751988410949707 2.311453342437744 0.0 0.0
0.6837480664253235 -2.186457633972168 -2.4202277660369873 7.300048565639372e-08 0.0
1.3086609840393066 -2.2517738342285156 -2.0693366527557373 1.1920928955078125e-07 0.0
1.37867271900177 -2.3172683715820312 0.28218093514442444 1.1920928955078125e-07 0.0
1.4008444547653198 -2.1907434463500977 1.6201627254486084 -1.4600097131278744e-07 0.0
0.6493402123451233 -2.285156726837158 2.7235107421875 -4.214684778958144e-08 0.0
1.9425572156906128 -2.1691806316375732 -1.8143287897109985 -1.6858739115832577e-07 0.0
4.072310447692871 -2.1499369144439697 -0.32157376408576965 -2.384185791015625e-07 0.0
2.0302693843841553 -2.0925817489624023 0.8865287899971008 -1.1920928955078125e-07 0.0
0.6822447180747986 -2.1702165603637695 2.6732733249664307 5.960464477539063e-08 0.0
2.26128888130188 -2.0112273693084717 -0.5584373474121094 0.0 0.0
0.7309778332710266 -1.9732179641723633 -0.48347586393356323 5.1619135632563484e-08 0.0
0.9792591333389282 -1.9414142370224 1.3102360963821411 -5.960464477539063e-08 0.0
0.7947579026222229 -1.871991515159607 0.043286506086587906 4.214684778958144e-08 0.0
2.9958581924438477 -1.894801139831543 1.3340555429458618 0.0 0.0
1.3717169761657715 -1.770559310913086 0.2786767780780792 5.960464477539063e-08 0.0
1.6252373456954956 -1.6567153930664062 -0.9181476831436157 -1.1920928955078125e-07 0.0
1.0862658023834229 -1.669396996498108 0.12108343839645386 5.960464477539063e-08 0.0
0.9765737056732178 -1.709842324256897 2.9964423179626465 4.214684778958144e-08 0.0
1.3598674535751343 -1.6167751550674438 -1.387428641319275 -5.960464477539063e-08 0.0
1.540661096572876 -1.6482267379760742 -0.6648080348968506 -5.960464477539063e-08 0.0
0.9882071614265442 -1.5459697246551514 3.0894415378570557 4.214684778958144e-08 0.0
5.031430721282959 -1.3029768466949463 0.6553076505661011 -1.1920928955078125e-07 0.0
4.969926357269287 -0.7845442891120911 0.1257995218038559 0.0 0.0
3.623232126235962 -0.729340672492981 1.2001070976257324 8.429369557916289e-08 0.0
2.3016204833984375 -0.7202723622322083 2.8280344009399414 -4.214684778958144e-08 0.0
3.707531452178955 0.10967028141021729 2.6346709728240967 0.0 0.0
4.368841171264648 0.27448317408561707 2.8184525966644287 0.0 0.0
5.135048866271973 0.3629467785358429 -1.9716287851333618 0.0 0.0
6.2958502769470215 0.5086323022842407 -1.33573317527771 1.1920928955078125e-07 0.0
18.9145450592041 0.5627573132514954 -1.526337742805481 4.129530850605079e-07 0.0
27.008743286132812 0.5341193675994873 -1.4042218923568726 3.3717478231665154e-07 0.0
4.9520182609558105 0.8790699243545532 1.5594884157180786 0.0 0.0
9.025590896606445 0.952949583530426 1.991207242012024 0.0 0.0
2.931777238845825 0.9628041982650757 0.594099760055542 0.0 0.0
7.537154197692871 1.0371758937835693 1.971123456954956 2.384185791015625e-07 0.0
1.747841715812683 0.9850072860717773 3.0346620082855225 2.9802322387695312e-08 0.0
4.371508598327637 1.1126658916473389 2.414412260055542 -8.429369557916289e-08 0.0
4.516269683837891 1.2004128694534302 -1.5071179866790771 1.6858739115832577e-07 0.0
1.1334846019744873 1.6010987758636475 0.7184727787971497 4.214684778958144e-08 0.0
1.9245989322662354 1.7122374773025513 -0.4310254156589508 1.0323827126512697e-07 0.0
0.6634104251861572 1.8963481187820435 -2.920619249343872 -5.1619135632563484e-08 0.0
2.821107864379883 2.0347177982330322 -1.4565924406051636 -1.1920928955078125e-07 0.0
0.7319841384887695 1.9863393306732178 0.5638716220855713 0.0 0.0
3.1192986965179443 2.1410231590270996 -2.515263557434082 2.384185791015625e-07 0.0
1.8092724084854126 2.1304163932800293 -1.3424131870269775 -8.429369557916289e-08 0.0
2.0621554851531982 2.0444157123565674 -1.0585908889770508 0.0 0.0
1.0223002433776855 2.093787431716919 0.09411664307117462 8.429369557916289e-08 0.0
3.8310790061950684 2.1458427906036377 2.119062900543213 -2.384185791015625e-07 0.0
0.8777185082435608 2.09102201461792 2.960874319076538 -4.214684778958144e-08 0.0
0.6919015645980835 2.1753132343292236 -2.4146268367767334 4.214684778958144e-08 0.0
1.3393781185150146 2.2663276195526123 -1.5143184661865234 -8.429369557916289e-08 0.0
1.5414893627166748 2.301482915878296 -1.2570381164550781 0.0 0.0
1.2063852548599243 2.2947213649749756 2.9315013885498047 8.429369557916289e-08 0.0
0.64225172996521 2.3136825561523438 3.0582072734832764 0.0 0.0
0.8877096176147461 2.3556394577026367 -0.6877276301383972 0.0 0.0
0.5291316509246826 2.3665153980255127 0.487789511680603 4.214684778958144e-08 0.0"""
# input text in format pt,eta,phi,mass,charge
pt, eta, phi, mass, charge = [], [], [], [], []
# now parse the input text
for line in input_text.strip().split('\n'):
    values = list(map(float, line.split()))
    pt.append(values[0])
    eta.append(values[1])
    phi.append(values[2])
    mass.append(values[3])
    charge.append(int(values[4]))

pid = torch.zeros(len(pt))
pf_cand_jet_idx = [-1] * len(pt)

pfcands = EventPFCands(pt, eta, phi, mass, charge, pid, pf_cand_jet_idx=pf_cand_jet_idx)
n_soft = 1000
pfcands = EventDataset.pfcands_add_soft_particles(pfcands, n_soft, random_generator=np.random)
event = Event(pfcands=pfcands)
event_batch = concat_events([event])
batch, _ = get_batch(event_batch, batch_config, torch.zeros(len(pfcands)), test=True)

with torch.no_grad():
    coords = model(batch, cpu_demo=True)[:, 1:4] # !!! Only use cpu_demo with batch size of 1 (quick fix for unavailability of xformers attention on CPU)
clust_labels = get_clustering_labels(coords.detach().cpu().numpy(), batch.batch_idx, min_cluster_size=args.min_cluster_size, min_samples=args.min_samples, epsilon=args.epsilon)
jets_pxyz = scatter_sum(torch.tensor(pfcands.pxyz), torch.tensor(clust_labels+1), dim=0)[1:]
jets_pt = torch.norm(jets_pxyz[:, :2], p=2, dim=-1)
filt = torch.where(jets_pt > 30)[0].tolist()
jets_eta, jets_phi = calc_eta_phi(jets_pxyz, False)
clust_assignment = {}
for i in range(len(clust_labels)):
    if clust_labels[i] in filt and clust_labels[i] != -1:
        clust_assignment[i] = filt.index(clust_labels[i])
jets_pt = jets_pt[filt]
jets_eta = jets_eta[filt]
jets_phi = jets_phi[filt]
ak_pt, ak_eta, ak_phi, _, ak_assignment = EventDataset.get_jets_fastjets_raw_with_assignment(pfcands, fastjet.JetDefinition(fastjet.antikt_algorithm, 0.8), pt_cutoff=30)
model_coords = calc_eta_phi(coords, return_stacked=0)
clist = ['#1f78b4', '#b3df8a', '#33a02c', '#fb9a99', '#e31a1c', '#fdbe6f', '#ff7f00', '#cab2d6', '#6a3d9a', '#ffff99',
         '#b15928']
colors = {
    -1: "gray",
    0: clist[0],
    1: clist[1],
    2: clist[2],
    3: clist[3],
    4: clist[4],
    5: clist[5],
    6: clist[6],
    7: clist[7],
}
c = []
c_ak = []
for i in range(len(pfcands)):
    if i in ak_assignment:
        c_ak.append(colors.get(ak_assignment[i], "purple"))
    else:
        c_ak.append("gray")
    if i in clust_assignment:
        c.append(colors.get(clust_assignment[i], "gray"))
    else:
        c.append("gray")
import matplotlib.pyplot as plt

fig, ax = plt.subplots(1, 3, figsize=(15, 5)) # with AK colors, with model colors, with model colors in clustering space
ax[0].set_title("Colors: AK clusters")
ax[1].set_title("Colors: Model clusters")
ax[2].set_title("Colors: Model clusters in clustering space")
plot_event(event, colors=c_ak, ax=ax[0], jets=0)
plot_event(event, colors=c, ax=ax[1], jets=0)
plot_event(event, colors=c, ax=ax[2], custom_coords=model_coords, jets=0)
for j in range(len(ak_pt)):
    if ak_pt[j] >= 30:
        ax[0].text(ak_eta[j] + 0.1, ak_phi[j] + 0.1,
                               "pt=" + str(round(ak_pt[j], 1)), color="blue", fontsize=6, alpha=0.5)
    if ak_pt[j] >= 100:
        for k in range(3):
            circle = plt.Circle((ak_eta[j], ak_phi[j]), 0.8, color="green", fill=False, alpha=.7)
            ax[k].add_artist(circle)


for j in range(len(jets_pt)):
    if jets_pt[j] >= 30:
        ax[1].text(jets_eta[j] + 0.1, jets_phi[j] + 0.1,
                               "pt=" + str(round(jets_pt[j].item(), 1)), color="gray", fontsize=6, alpha=0.5)
    if jets_pt[j] >= 100:
        for k in range(3):
            circle = plt.Circle((jets_eta[j], jets_phi[j]), 0.77, color="blue", fill=False, alpha=.7)
            ax[k].add_artist(circle)
for k in range(3):
    ax[k].set_xlabel("$\eta$")
    ax[k].set_ylabel("$\phi$")
fig.tight_layout()
fig.show()
fig.savefig("/work/gkrzmanc/tmp.pdf")

